<!DOCTYPE html>
<html>
<head>
 <meta charset="utf-8">
 <meta name="viewport" content="width=device-width, initial-scale=1">
 <title>NEXUS PROTOCOL - AUTORIZACIÓN</title>
 <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
 <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
 <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
 <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
 <script src="https://accounts.google.com/gsi/client" async defer></script>
 <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
 <script src="clienteRest.js"></script>
 <script src="controlWeb.js"></script>
 <script src="clienteWS.js"></script>
 <style>
  body {
   background: linear-gradient(135deg, #1a0a2e 0%, #3d1f5c 50%, #1a0a2e 100%) !important;
   margin: 0;
   padding: 0;
   min-height: 100vh;
   font-family: 'Courier New', monospace;
  }
  .container {
   background-color: transparent;
  }
  .hero-section {
   background: linear-gradient(135deg, #1a0a2e 0%, #3d1f5c 100%);
   color: white;
   padding: 100px 0;
   min-height: 80vh;
   display: flex;
   align-items: center;
   position: relative;
  }
  .hero-section::before {
   content: '';
   position: absolute;
   top: 0;
   left: 0;
   right: 0;
   bottom: 0;
   background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="%23ffffff" fill-opacity="0.1" d="M0,96L48,112C96,128,192,160,288,160C384,160,480,128,576,122.7C672,117,768,139,864,138.7C960,139,1056,117,1152,101.3C1248,85,1344,75,1392,69.3L1440,64L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path></svg>') bottom center no-repeat;
   background-size: cover;
   opacity: 0.3;
  }
  .hero-section h1 {
   color: #ff1493;
   text-shadow: 0 0 20px #ff1493, 0 0 40px #ff1493;
   font-weight: 700;
   letter-spacing: 4px;
   animation: glow 2s ease-in-out infinite alternate;
  }
  @keyframes glow {
   from { text-shadow: 0 0 20px #ff1493, 0 0 30px #ff1493; }
   to { text-shadow: 0 0 30px #ff1493, 0 0 60px #ff1493, 0 0 80px #ff69b4; }
  }
  .hero-section p {
   color: #ff69b4;
   font-size: 1.2rem;
   text-shadow: 0 0 10px rgba(255, 105, 180, 0.5);
   letter-spacing: 1px;
  }
  .feature-icon {
   font-size: 3rem;
   color: #ff6b35;
   margin-bottom: 1rem;
   text-shadow: 0 0 15px #ff6b35;
  }
  .btn-custom {
   padding: 15px 45px;
   font-size: 1.1rem;
   border-radius: 50px;
   margin: 10px;
   font-weight: 600;
   transition: all 0.3s ease;
   text-transform: uppercase;
   letter-spacing: 0.5px;
  }
  .btn-custom.btn-light {
   background: linear-gradient(135deg, #9d4edd 0%, #ff1493 100%);
   color: white;
   border: 2px solid #ff69b4;
   box-shadow: 0 0 20px rgba(255, 105, 180, 0.5);
   letter-spacing: 2px;
  }
  .btn-custom.btn-light:hover {
   background: linear-gradient(135deg, #ff1493 0%, #9d4edd 100%);
   transform: translateY(-3px);
   box-shadow: 0 0 30px rgba(255, 105, 180, 0.8);
   color: white;
   border-color: #ff1493;
  }
  .btn-custom.btn-outline-light {
   background: rgba(157, 78, 221, 0.2);
   color: #ff69b4;
   border: 3px solid #ff69b4;
   backdrop-filter: blur(10px);
   letter-spacing: 2px;
  }
  .btn-custom.btn-outline-light:hover {
   background: rgba(255, 105, 180, 0.3);
   color: #ff1493;
   border: 3px solid #ff1493;
   transform: translateY(-3px);
   box-shadow: 0 0 25px rgba(255, 105, 180, 0.6);
  }
  .google-btn {
   background: white;
   color: #333;
   border: 2px solid #ddd;
  }
  .google-btn:hover {
   background: #f8f9fa;
   color: #333;
  }
  .card-login {
   border-radius: 20px;
   box-shadow: 0 0 40px rgba(157, 78, 221, 0.5);
   background: rgba(10, 5, 32, 0.95);
   border: 2px solid #9d4edd;
  }
  .card {
   background: rgba(10, 5, 32, 0.9) !important;
   border: 2px solid #9d4edd;
   border-radius: 15px;
   transition: all 0.3s ease;
  }
  .card:hover {
   transform: translateY(-5px);
   box-shadow: 0 0 30px rgba(255, 105, 180, 0.5);
   border-color: #ff69b4;
  }
  #dashboard {
   background: linear-gradient(to bottom, #1a0a2e 0%, #0a0520 100%) !important;
   min-height: 100vh;
   padding-bottom: 50px;
  }
  .btn-primary, .btn-dark {
   background: linear-gradient(135deg, #9d4edd 0%, #ff1493 100%) !important;
   border: 2px solid #ff69b4 !important;
   color: white !important;
   font-weight: 600;
   transition: all 0.3s ease;
   box-shadow: 0 0 20px rgba(255, 105, 180, 0.5);
   letter-spacing: 1px;
  }
  .btn-primary:hover, .btn-dark:hover {
   background: linear-gradient(135deg, #ff1493 0%, #9d4edd 100%) !important;
   transform: translateY(-2px);
   box-shadow: 0 0 30px rgba(255, 105, 180, 0.8);
   color: white !important;
   border-color: #ff1493 !important;
  }
  .btn-outline-dark {
   border-color: #ff9800 !important;
   color: #ff9800 !important;
   font-weight: 600;
   transition: all 0.3s ease;
  }
  .btn-outline-dark:hover {
   background: linear-gradient(135deg, #ff9800 0%, #ff6b35 100%) !important;
   color: white !important;
   border-color: #ff9800 !important;
   transform: translateY(-2px);
  }
  .btn-success {
   background: linear-gradient(135deg, #ff6b35 0%, #ff1493 100%) !important;
   border: 2px solid #ff6b35 !important;
   color: white !important;
   font-weight: 600;
   transition: all 0.3s ease;
   box-shadow: 0 0 15px rgba(255, 107, 53, 0.5);
   letter-spacing: 1px;
  }
  .btn-success:hover {
   background: linear-gradient(135deg, #ff1493 0%, #ff6b35 100%) !important;
   transform: translateY(-2px);
   box-shadow: 0 0 25px rgba(255, 107, 53, 0.8);
   color: white !important;
   border-color: #ff1493 !important;
  }
  .btn-outline-danger {
   transition: all 0.3s ease;
  }
  .btn-outline-danger:hover {
   transform: translateY(-2px);
  }
 </style>
 <script>
 $(document).ready(function(){
   const urlParams = new URLSearchParams(window.location.search);
   // Solo mostrar modal si no tiene cookie de nick
   const nickCookie = document.cookie.split('; ').find(row => row.startsWith('nick='));
   if (urlParams.get('elegirNick') === 'true' && !nickCookie) {
     $('#modalNickGoogle').modal('show');
   } else if (urlParams.get('elegirNick') === 'true' && nickCookie) {
     // Si tiene cookie pero está la URL con elegirNick, limpiar la URL
     window.history.replaceState({}, document.title, '/');
   }
 });
 </script>
 
 <script>
 // Detectar si debe abrir el menú NEXUS automáticamente
 $(document).ready(function() {
   const urlParams = new URLSearchParams(window.location.search);
   if (urlParams.get('openMenu') === 'true') {
     // Esperar a que cw esté inicializado
     setTimeout(function() {
       if (typeof cw !== 'undefined' && cw.mostrarMenuNexus) {
         cw.mostrarMenuNexus();
       }
     }, 500);
   }
 });
 </script>
</head>
<body>

<!-- Google One Tap configuration -->
<div
 id="g_id_onload"
 data-client_id="145905119803-2bftmurjt68oacbojb4ra1vm01nubqs2.apps.googleusercontent.com"
 data-callback="handleCredentialResponse"
 data-auto_prompt="true"
 data-cancel_on_tap_outside="false"
 data-context="signin"
 data-itp_support="true"
></div>

<script>
// Callback para manejar la respuesta de Google One Tap
function handleCredentialResponse(response) {
 console.log('[OneTap Client] ===== CALLBACK EJECUTADO =====');
 console.log('[OneTap Client] Credencial recibida:', response.credential.substring(0, 50) + '...');
 console.log('[OneTap Client] Enviando al servidor...');
 
 // Enviar la credencial al servidor
 fetch('/oneTap/callback', {
  method: 'POST',
  headers: {
   'Content-Type': 'application/json',
  },
  body: JSON.stringify({
   credential: response.credential
  }),
  credentials: 'same-origin'
 })
 .then(res => {
  console.log('[OneTap Client] Respuesta del servidor:', res.status, res.statusText);
  console.log('[OneTap Client] Redirected:', res.redirected);
  if (res.redirected) {
   console.log('[OneTap Client] Redirigiendo a:', res.url);
   window.location.href = res.url;
  } else if (res.ok) {
   return res.json().then(data => {
    console.log('[OneTap Client] Datos JSON recibidos:', data);
    return data;
   });
  } else {
   return res.text().then(text => {
    console.error('[OneTap Client] Error del servidor:', text);
    throw new Error('Error en la autenticación: ' + res.status);
   });
  }
 })
 .then(data => {
  if (data) {
   console.log('[OneTap Client] Procesando datos:', data);
   window.location.reload();
  }
 })
 .catch(error => {
  console.error('[OneTap Client] ===== ERROR =====');
  console.error('[OneTap Client] Error completo:', error);
 });
}

// Verificar que la función está disponible
console.log('[OneTap Client] Función handleCredentialResponse definida:', typeof handleCredentialResponse);
</script>

<nav class="navbar navbar-expand-lg navbar-dark" style="background: linear-gradient(135deg, #1a0a2e 0%, #3d1f5c 100%); box-shadow: 0 0 20px rgba(157, 78, 221, 0.5); border-bottom: 2px solid #9d4edd;">
 <div class="container">
  <a class="navbar-brand font-weight-bold" href="#" style="font-size: 1.5rem; color: #ff1493; text-shadow: 0 0 10px #ff1493; letter-spacing: 3px; font-family: 'Courier New', monospace;">
   <img src="img/logo.png" alt="Logo" style="height: 60px; margin-right: 15px; filter: drop-shadow(0 0 10px #ff1493);"> NEXUS SYSTEM
  </a>
  <button class="btn btn-sm ml-auto" onclick="cw.salir()" id="btnSalir" style="display: none; background: linear-gradient(135deg, #9d4edd 0%, #ff1493 100%); border: 2px solid #ff69b4; color: white; letter-spacing: 1px;">
   <i class="fas fa-sign-out-alt"></i> SALIR
  </button>
 </div>
</nav>


<div id="landingPage" style="display: none;">
 <section class="hero-section">
  <div class="container">
   <div class="row align-items-center">
    <div class="col-lg-6 text-center text-lg-left mb-5 mb-lg-0">
     <h1 class="display-3 font-weight-bold mb-4">NEXUS PROTOCOL</h1>
     <p class="lead mb-5">[ SISTEMA DE COMBATE TÁCTICO DE TANQUES - AUTORIZACIÓN REQUERIDA ]</p>
     <div class="d-flex flex-column flex-md-row justify-content-center justify-content-lg-start">
      <button class="btn btn-light btn-custom" onclick="cw.mostrarLoginForm()">
       <i class="fas fa-sign-in-alt"></i> Iniciar Sesión
      </button>
      <button class="btn btn-outline-light btn-custom" onclick="cw.mostrarRegistroForm()">
       <i class="fas fa-user-plus"></i> Registrarse
      </button>
     </div>
    </div>
    <div class="col-lg-6">
     <div class="text-center">
      <img src="img/PaginaPrincipal.png" alt="Nexus Protocol" style="max-width: 100%; height: auto; border-radius: 15px; box-shadow: 0 0 40px rgba(255,20,147,0.6), 0 0 80px rgba(157,78,221,0.4); animation: pulse 2s infinite;">
     </div>
    </div>
   </div>
  </div>
 </section>
 <style>
  @keyframes pulse {
   0%, 100% { transform: scale(1); }
   50% { transform: scale(1.1); }
  }
 </style>

 <!-- Login Form Modal -->
 <div id="loginFormSection" style="display: none; padding: 60px 0; background: linear-gradient(135deg, #1a0a2e 0%, #0a0520 100%);">
  <div class="container">
   <div class="row justify-content-center">
    <div class="col-md-6 col-lg-5">
     <div class="card card-login">
      <div class="card-body p-5">
       <h3 class="text-center mb-4" style="color: #ff1493; text-shadow: 0 0 15px #ff1493; letter-spacing: 3px;"><i class="fas fa-sign-in-alt"></i> INICIAR SESIÓN</h3>
       <div id="mensajeLogin" class="alert" style="display: none;"></div>
       <form id="formLogin">
        <div class="form-group">
         <label for="emailLogin" style="color: #ff69b4; font-weight: bold;"><i class="fas fa-envelope"></i> Email:</label>
         <input type="email" class="form-control" id="emailLogin" placeholder="tu@email.com" required style="background: rgba(26, 10, 46, 0.7); border: 1px solid #9d4edd; color: #ff69b4;">
        </div>
        <div class="form-group">
         <label for="passwordLogin" style="color: #ff69b4; font-weight: bold;"><i class="fas fa-key"></i> Contraseña:</label>
         <input type="password" class="form-control" id="passwordLogin" placeholder="••••••••" required style="background: rgba(26, 10, 46, 0.7); border: 1px solid #9d4edd; color: #ff69b4;">
        </div>
        <button type="submit" class="btn btn-primary btn-block btn-lg">INICIAR SESIÓN</button>
       </form>
       <hr style="border-color: #9d4edd;">
       <p class="text-center mb-3" style="color: #9d4edd;">O inicia sesión con:</p>
       <a href="/auth/google" class="btn btn-block google-btn" style="background: white; color: #333; border: 2px solid #9d4edd;">
        <i class="fab fa-google"></i> Continuar con Google
       </a>
       <div class="text-center mt-3">
        <small style="color: #9d4edd;">¿No tienes cuenta? <a href="#" onclick="cw.mostrarRegistroForm(); return false;" class="font-weight-bold" style="color: #ff1493; text-decoration: none;">Regístrate aquí</a></small>
       </div>
       <div class="text-center mt-2">
        <button class="btn btn-link" onclick="cw.volverLanding()" style="color: #ff69b4;">
         <i class="fas fa-arrow-left"></i> Volver
        </button>
       </div>
      </div>
     </div>
    </div>
   </div>
  </div>
 </div>

 <div id="registroFormSection" style="display: none; padding: 60px 0; background: linear-gradient(135deg, #1a0a2e 0%, #0a0520 100%);">
  <div class="container">
   <div class="row justify-content-center">
    <div class="col-md-6 col-lg-5">
     <div class="card card-login">
      <div class="card-body p-5">
       <h3 class="text-center mb-4" style="color: #ff1493; text-shadow: 0 0 15px #ff1493; letter-spacing: 3px;"><i class="fas fa-user-plus"></i> CREAR CUENTA</h3>
       <div id="mensajeRegistro" class="alert" style="display: none;"></div>
       <form id="formRegistro">
        <div class="form-group">
         <label for="nickRegistro" style="color: #ff69b4; font-weight: bold;"><i class="fas fa-user"></i> Nick (Usuario):</label>
         <input type="text" class="form-control" id="nickRegistro" placeholder="Elige tu nick único" required style="background: rgba(26, 10, 46, 0.7); border: 1px solid #9d4edd; color: #ff69b4;">
         <small class="form-text" style="color: #9d4edd;">3-20 caracteres: letras, números y guiones bajos</small>
        </div>
        <div class="form-group">
         <label for="emailRegistro" style="color: #ff69b4; font-weight: bold;"><i class="fas fa-envelope"></i> Email:</label>
         <input type="email" class="form-control" id="emailRegistro" placeholder="tu@email.com" required style="background: rgba(26, 10, 46, 0.7); border: 1px solid #9d4edd; color: #ff69b4;">
        </div>
        <div class="form-group">
         <label for="passwordRegistro" style="color: #ff69b4; font-weight: bold;"><i class="fas fa-key"></i> Contraseña:</label>
         <input type="password" class="form-control" id="passwordRegistro" placeholder="Mínimo 6 caracteres" required style="background: rgba(26, 10, 46, 0.7); border: 1px solid #9d4edd; color: #ff69b4;">
        </div>
        <button type="submit" class="btn btn-success btn-block btn-lg">CREAR CUENTA</button>
       </form>
       <hr style="border-color: #9d4edd;">
       <p class="text-center mb-3" style="color: #9d4edd;">O regístrate con:</p>
       <a href="/auth/google" class="btn btn-block google-btn" style="background: white; color: #333; border: 2px solid #9d4edd;">
        <i class="fab fa-google"></i> Continuar con Google
       </a>
       <div class="text-center mt-3">
        <small style="color: #9d4edd;">¿Ya tienes cuenta? <a href="#" onclick="cw.mostrarLoginForm(); return false;" class="font-weight-bold" style="color: #ff1493; text-decoration: none;">Inicia sesión aquí</a></small>
       </div>
       <div class="text-center mt-2">
        <button class="btn btn-link" onclick="cw.volverLanding()" style="color: #ff69b4;">
         <i class="fas fa-arrow-left"></i> Volver
        </button>
       </div>
      </div>
     </div>
    </div>
   </div>
  </div>
 </div>
</div>

<!-- Dashboard - Visible solo con sesión -->
<div id="dashboard" style="display: none;">
 <div class="container mt-4">
  <!-- Welcome Message -->
  <div id="welcomeMessage"></div>

  <!-- Header section -->
  <div class="row mb-4">
   <div class="col-12 text-center">
    <h2 class="mb-1" style="color: #ff1493; text-shadow: 0 0 15px #ff1493; letter-spacing: 5px; font-family: 'Courier New', monospace;"><i class="fas fa-gamepad"></i> TERMINAL DE COMBATE</h2>
    <p style="color: #9d4edd; letter-spacing: 2px; font-family: 'Courier New', monospace;">[ ACCESO AL SISTEMA DE BATALLA ]</p>
   </div>
  </div>

  <!-- Cards para cada función -->
  <div class="row justify-content-center">
  
  <!-- NEXUS PROTOCOL - Botón destacado que lleva al lobby -->
  <div class="col-md-10 col-lg-8 mb-4">
   <div class="card h-100 shadow" style="background: linear-gradient(135deg, #1a0a2e 0%, #3d1f5c 100%); border: 3px solid #ff69b4;">
    <div class="card-body text-center" style="padding: 40px;">
     <h3 class="card-title mb-3" style="color: #ff1493; font-family: 'Courier New', monospace; letter-spacing: 8px; text-shadow: 0 0 20px #ff1493, 0 0 40px #ff1493; animation: glow 2s ease-in-out infinite alternate;">
      NEXUS PROTOCOL
     </h3>
     <p class="card-text mb-4" style="color: #ff6b35; font-family: 'Courier New', monospace; letter-spacing: 2px;">
      SISTEMA DE COMBATE ACTIVADO
     </p>
     <button onclick="irALobby()" class="btn btn-lg" style="background: linear-gradient(135deg, #9d4edd 0%, #ff1493 100%); border: 2px solid #ff69b4; color: #fff; padding: 15px 50px; font-family: 'Courier New', monospace; letter-spacing: 3px; transition: all 0.3s; box-shadow: 0 0 20px rgba(255, 105, 180, 0.5); cursor: pointer;">
      <i class="fas fa-gamepad"></i> ENTRAR AL LOBBY
     </button>
    </div>
   </div>
  </div>
  
  <script>
  function irALobby() {
    console.log('Intentando ir al lobby...');
    window.location.href = '/lobby';
  }
  </script>
  
  <style>
  @keyframes glow {
    from { text-shadow: 0 0 20px #ff1493, 0 0 30px #ff1493; }
    to { text-shadow: 0 0 30px #ff1493, 0 0 60px #ff1493, 0 0 80px #ff69b4; }
  }
  </style>
 </div>

 <!-- Área de trabajo oculta -->
 <div id="au" style="display: none;"></div>
 <div id="registro"></div>
 <div id="msg"></div>
 <div id="contenido" style="display: none;"></div>
 </div>
</div>

<!-- Modal para elegir nick de Google -->
<div class="modal fade" id="modalNickGoogle" tabindex="-1" role="dialog">
 <div class="modal-dialog modal-dialog-centered" role="document">
  <div class="modal-content">
   <div class="modal-header">
    <h5 class="modal-title"><i class="fas fa-user-tag"></i> Elige tu Nick</h5>
   </div>
   <div class="modal-body">
    <p>Para completar tu registro con Google, por favor elige un nick y crea una contraseña:</p>
    <div id="mensajeNickGoogle" class="alert" style="display: none;"></div>
    <div class="form-group">
     <label for="nickGoogle">Nick:</label>
     <input type="text" class="form-control" id="nickGoogle" placeholder="Tu nick único">
     <small class="form-text text-muted">3-20 caracteres: letras, números y guiones bajos</small>
    </div>
    <div class="form-group">
     <label for="passwordGoogle">Contraseña:</label>
     <input type="password" class="form-control" id="passwordGoogle" placeholder="Crea una contraseña">
     <small class="form-text text-muted">Mínimo 6 caracteres</small>
    </div>
   </div>
   <div class="modal-footer">
    <button type="button" class="btn btn-primary" id="btnGuardarNickGoogle">Guardar</button>
   </div>
  </div>
 </div>
</div>


<script>
rest=new ClienteRest();
cw=new ControlWeb();
ws=new ClienteWS();

// Inicializar Google Sign-In
window.onload = function() {
	// Comprobar sesión al cargar la página
	cw.comprobarSesion();
	
	console.log('[Init] Verificando handleCredentialResponse:', typeof window.handleCredentialResponse);
};

// Función para mostrar componentes en las cards
function mostrarFuncion(funcion, boton) {
    // Limpiar todos los resultados
    $('[id^="result-"]').empty();
    
    // Obtener el div de resultado específico
    const resultDiv = $('#result-' + funcion);
    
    // Cambiar el texto del botón temporalmente
    const originalText = $(boton).text();
    $(boton).text('Cargando...').prop('disabled', true);
    
    switch(funcion) {
        case 'crearPartida':
            mostrarCrearPartidaEnCard(resultDiv, boton, originalText);
            break;
        case 'unirsePartida':
            mostrarUnirsePartidaEnCard(resultDiv, boton, originalText);
            break;
    }
}

function mostrarCrearPartidaEnCard(resultDiv, boton, originalText) {
    const botonHtml = `
        <div class="border-top pt-3">
            <button class="btn btn-success btn-sm btn-block" onclick="ejecutarCrearPartida()">
                <i class="fas fa-plus-circle"></i> Crear Partida
            </button>
            <div id="estadoPartida" class="mt-3"></div>
        </div>
    `;
    resultDiv.html(botonHtml);
    $(boton).text(originalText).prop('disabled', false);
}

function mostrarUnirsePartidaEnCard(resultDiv, boton, originalText) {
    ws.obtenerPartidasDisponibles();
    
    const contenido = `
        <div class="border-top pt-3">
            <button class="btn btn-info btn-sm btn-block mb-2" onclick="ws.obtenerPartidasDisponibles()">
                <i class="fas fa-sync-alt"></i> Actualizar Lista
            </button>
            <div id="listaPartidasCard" class="mt-2">
                <div class="text-center text-muted">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="sr-only">Cargando...</span>
                    </div>
                    <small class="d-block mt-2">Cargando partidas...</small>
                </div>
            </div>
        </div>
    `;
    resultDiv.html(contenido);
    $(boton).text(originalText).prop('disabled', false);
}

function ejecutarCrearPartida() {
    ws.crearPartida();
    $('#estadoPartida').html(`
        <div class="text-center">
            <div class="spinner-border text-success spinner-border-sm" role="status">
                <span class="sr-only">Cargando...</span>
            </div>
            <p class="mt-2 mb-1"><small class="text-success"><strong>Esperando rival...</strong></small></p>
            <p class="mb-0"><small class="text-muted">Código: <span id="codigoPartidaCard" class="badge badge-primary"></span></small></p>
        </div>
    `);
    
    // Actualizar el código cuando esté disponible
    setTimeout(function() {
        if (ws.codigo) {
            $('#codigoPartidaCard').text(ws.codigo);
        }
    }, 500);
}

function ejecutarUnirsePartida(codigo) {
    ws.unirAPartida(codigo);
    $('#listaPartidasCard').html(`
        <div class="alert alert-success alert-sm mb-0">
            <i class="fas fa-check-circle"></i> Uniéndose a la partida ${codigo}...
        </div>
    `);
}
</script>

<!-- Incluir modal para elegir nick de Google -->
<div id="modalNickGoogleContainer"></div>
<script>
$(document).ready(function(){
  // Cargar modal de nick para Google
  $('#modalNickGoogleContainer').load('modalNick.html', function(){
    // Configurar evento del botón
    $('#btnGuardarNickGoogle').on('click', function(){
      let nick = $('#nickGoogle').val().trim();
      let password = $('#passwordGoogle').val();
      
      // Validar nick
      const nickRegex = /^[a-zA-Z0-9_]{3,20}$/;
      if (!nickRegex.test(nick)) {
        $('#mensajeNickGoogle').removeClass('alert-success').addClass('alert-danger')
          .text('El nick debe tener entre 3 y 20 caracteres (solo letras, números y guiones bajos)')
          .show();
        return;
      }
      
      // Validar contraseña
      if (!password || password.length < 6) {
        $('#mensajeNickGoogle').removeClass('alert-success').addClass('alert-danger')
          .text('La contraseña debe tener al menos 6 caracteres')
          .show();
        return;
      }
      
      // Enviar nick y contraseña al servidor
      $.ajax({
        type: 'POST',
        url: '/guardarNickGoogle',
        data: JSON.stringify({nick: nick, password: password}),
        contentType: 'application/json',
        success: function(data){
          if (data.success) {
            $('#modalNickGoogle').modal('hide');
            // Guardar cookies manualmente para asegurar que persistan
            document.cookie = 'nick=' + data.nick + '; path=/; max-age=' + (7*24*60*60);
            document.cookie = 'email=' + data.email + '; path=/; max-age=' + (7*24*60*60);
            // Guardar email en ws si está disponible
            if (data.email) {
              ws.email = data.email;
            }
            // Mostrar mensaje de éxito y recargar
            $('#mensajeNickGoogle').removeClass('alert-danger').addClass('alert-success')
              .text('¡Cuenta creada exitosamente! Redirigiendo...').show();
            // Redirigir a la raíz sin parámetros después de un pequeño delay
            setTimeout(function() {
              window.location.href = '/';
            }, 500);
          } else {
            let mensaje = 'Error al guardar el nick';
            if (data.error === 'nick') {
              mensaje = 'Este nick ya está en uso. Por favor, elige otro.';
            }
            $('#mensajeNickGoogle').removeClass('alert-success').addClass('alert-danger')
              .text(mensaje).show();
          }
        },
        error: function(){
          $('#mensajeNickGoogle').removeClass('alert-success').addClass('alert-danger')
            .text('Error al conectar con el servidor').show();
        }
      });
    });
  });
});
</script>

<!-- Modal personalizado -->
<div class="modal fade" id="miModal" tabindex="-1" role="dialog" aria-labelledby="miModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <!-- Header -->
      <div class="modal-header">
        <h4 class="modal-title" id="miModalLabel">Atención</h4>
        <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <!-- Body -->
      <div class="modal-body" id="mBody">
        <!-- Aquí pones el contenido dinámico que quieras mostrar -->
      </div>

      <!-- Footer -->
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

</body>
</html>