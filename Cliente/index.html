<!DOCTYPE html>
<html>
<head>
 <meta charset="utf-8">
 <meta name="viewport" content="width=device-width, initial-scale=1">
 <title>Procesos: Sprint 1 </title>
 <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
 <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
 <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
 <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
 <script src="modelo.js"></script>
 <script src="clienteRest.js"></script>
 <script src="controlWeb.js"></script>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
 <div class="container">
  <a class="navbar-brand font-weight-bold text-primary" href="#">UserManager</a>
  <span class="navbar-text text-muted">Sistema de Gestión de Usuarios</span>
 </div>
</nav>
<div class="container mt-4">
 <!-- Header section -->
 <div class="row mb-4">
  <div class="col-12">
   <h2 class="text-dark mb-1">Panel de Control</h2>
   <p class="text-muted">Gestione usuarios de forma eficiente con nuestras herramientas</p>
  </div>
 </div>

 <!-- Cards para cada función -->
 <div class="row">
  <!-- Agregar Usuario -->
  <div class="col-md-6 col-lg-4 mb-4">
   <div class="card h-100 shadow-sm">
    <div class="card-body">
     <h5 class="card-title">Agregar Usuario</h5>
     <p class="card-text text-muted small">Registre un nuevo usuario en el sistema</p>
     <button type="button" class="btn btn-outline-dark btn-sm" onclick="mostrarFuncion('agregarUsuario', this)">
      Mostrar
     </button>
     <div id="result-agregarUsuario" class="mt-3"></div>
    </div>
   </div>
  </div>

  <!-- Ver Usuarios -->
  <div class="col-md-6 col-lg-4 mb-4">
   <div class="card h-100 shadow-sm">
    <div class="card-body">
     <h5 class="card-title">Ver Usuarios</h5>
     <p class="card-text text-muted small">Consulte la lista completa de usuarios</p>
     <button type="button" class="btn btn-outline-dark btn-sm" onclick="mostrarFuncion('obtenerUsuarios', this)">
      Consultar
     </button>
     <div id="result-obtenerUsuarios" class="mt-3"></div>
    </div>
   </div>
  </div>

  <!-- Contar Usuarios -->
  <div class="col-md-6 col-lg-4 mb-4">
   <div class="card h-100 shadow-sm">
    <div class="card-body">
     <h5 class="card-title">Total Usuarios</h5>
     <p class="card-text text-muted small">Obtenga el número total de usuarios registrados</p>
     <button type="button" class="btn btn-outline-dark btn-sm" onclick="mostrarFuncion('numeroUsuarios', this)">
      Contar
     </button>
     <div id="result-numeroUsuarios" class="mt-3"></div>
    </div>
   </div>
  </div>

  <div class="col-md-6 col-lg-4 mb-4">
   <div class="card h-100 shadow-sm">
    <div class="card-body">
     <h5 class="card-title">Verificar Usuario</h5>
     <p class="card-text text-muted small">Compruebe si un usuario está activo</p>
     <button type="button" class="btn btn-outline-dark btn-sm" onclick="mostrarFuncion('usuarioActivo', this)">
      Verificar
     </button>
     <div id="result-usuarioActivo" class="mt-3"></div>
    </div>
   </div>
  </div>

  
  <div class="col-md-6 col-lg-4 mb-4">
   <div class="card h-100 shadow-sm">
    <div class="card-body">
     <h5 class="card-title">Eliminar Usuario</h5>
     <p class="card-text text-muted small">Elimine un usuario del sistema</p>
     <button type="button" class="btn btn-outline-dark btn-sm" onclick="mostrarFuncion('eliminarUsuario', this)">
      Eliminar
     </button>
     <div id="result-eliminarUsuario" class="mt-3"></div>
    </div>
   </div>
  </div>

  <!-- Limpiar -->
  <div class="col-md-6 col-lg-4 mb-4">
   <div class="card h-100 shadow-sm">
    <div class="card-body">
     <h5 class="card-title">Limpiar</h5>
     <p class="card-text text-muted small">Limpie todos los formularios y resultados</p>
     <button type="button" class="btn btn-outline-secondary btn-sm" onclick="limpiarTodo()">
      Limpiar Todo
     </button>
    </div>
   </div>
  </div>
 </div>

 <!-- Área de trabajo oculta -->
 <div id="au" style="display: none;"></div>
 <div id="contenido" style="display: none;"></div>
</div>
<script>
rest=new ClienteRest();
cw=new ControlWeb();

// Función para mostrar componentes en las cards
function mostrarFuncion(funcion, boton) {
    // Limpiar todos los resultados
    $('[id^="result-"]').empty();
    
    // Obtener el div de resultado específico
    const resultDiv = $('#result-' + funcion);
    
    // Cambiar el texto del botón temporalmente
    const originalText = $(boton).text();
    $(boton).text('Cargando...').prop('disabled', true);
    
    switch(funcion) {
        case 'agregarUsuario':
            mostrarAgregarUsuarioEnCard(resultDiv, boton, originalText);
            break;
        case 'obtenerUsuarios':
            mostrarObtenerUsuariosEnCard(resultDiv, boton, originalText);
            break;
        case 'numeroUsuarios':
            mostrarNumeroUsuariosEnCard(resultDiv, boton, originalText);
            break;
        case 'usuarioActivo':
            mostrarUsuarioActivoEnCard(resultDiv, boton, originalText);
            break;
        case 'eliminarUsuario':
            mostrarEliminarUsuarioEnCard(resultDiv, boton, originalText);
            break;
    }
}

function mostrarAgregarUsuarioEnCard(resultDiv, boton, originalText) {
    const form = `
        <div class="border-top pt-3">
            <div class="form-group mb-2">
                <input type="text" class="form-control form-control-sm" id="nickAgregar" placeholder="Ingrese el nick">
            </div>
            <button class="btn btn-dark btn-sm btn-block" onclick="ejecutarAgregarUsuario()">Agregar</button>
        </div>
    `;
    resultDiv.html(form);
    $(boton).text(originalText).prop('disabled', false);
}

function mostrarObtenerUsuariosEnCard(resultDiv, boton, originalText) {
    $.ajax({
        type:'GET',
        url:'/obtenerUsuarios',
        success:function(data){
            let usuarios = '<div class="border-top pt-3"><small class="text-muted">Usuarios registrados:</small><div class="mt-2">';
            const userList = Object.keys(data);
            if(userList.length === 0) {
                usuarios += '<span class="badge badge-light">No hay usuarios</span>';
            } else {
                userList.forEach(nick => {
                    usuarios += `<span class="badge badge-secondary mr-1 mb-1">${nick}</span>`;
                });
            }
            usuarios += '</div></div>';
            resultDiv.html(usuarios);
            $(boton).text(originalText).prop('disabled', false);
        },
        error:function(){
            resultDiv.html('<div class="border-top pt-3"><small class="text-danger">Error al obtener usuarios</small></div>');
            $(boton).text(originalText).prop('disabled', false);
        }
    });
}

function mostrarNumeroUsuariosEnCard(resultDiv, boton, originalText) {
    $.ajax({
        type:'GET',
        url:'/numeroUsuarios',
        success:function(data){
            resultDiv.html(`
                <div class="border-top pt-3">
                    <div class="text-center">
                        <h4 class="text-dark mb-0">${data.num}</h4>
                        <small class="text-muted">usuarios registrados</small>
                    </div>
                </div>
            `);
            $(boton).text(originalText).prop('disabled', false);
        },
        error:function(){
            resultDiv.html('<div class="border-top pt-3"><small class="text-danger">Error al contar usuarios</small></div>');
            $(boton).text(originalText).prop('disabled', false);
        }
    });
}

function mostrarUsuarioActivoEnCard(resultDiv, boton, originalText) {
    const form = `
        <div class="border-top pt-3">
            <div class="form-group mb-2">
                <input type="text" class="form-control form-control-sm" id="nickVerificar" placeholder="Ingrese el nick a verificar">
            </div>
            <button class="btn btn-dark btn-sm btn-block" onclick="ejecutarVerificarUsuario()">Verificar</button>
            <div id="resultadoVerificar" class="mt-2"></div>
        </div>
    `;
    resultDiv.html(form);
    $(boton).text(originalText).prop('disabled', false);
}

function mostrarEliminarUsuarioEnCard(resultDiv, boton, originalText) {
    const form = `
        <div class="border-top pt-3">
            <div class="form-group mb-2">
                <input type="text" class="form-control form-control-sm" id="nickEliminar" placeholder="Ingrese el nick a eliminar">
            </div>
            <button class="btn btn-outline-danger btn-sm btn-block" onclick="ejecutarEliminarUsuario()">Eliminar</button>
            <div id="resultadoEliminar" class="mt-2"></div>
        </div>
    `;
    resultDiv.html(form);
    $(boton).text(originalText).prop('disabled', false);
}

// Funciones de ejecución
function ejecutarAgregarUsuario() {
    const nick = $('#nickAgregar').val();
    if(nick) {
        rest.agregarUsuario(nick);
        $('#nickAgregar').val('');
        setTimeout(() => {
            $('#result-agregarUsuario').html('<div class="border-top pt-3"><small class="text-success">Usuario agregado correctamente</small></div>');
        }, 500);
    }
}

function ejecutarVerificarUsuario() {
    const nick = $('#nickVerificar').val();
    if(nick) {
        $.ajax({
            type:'GET',
            url:'/usuarioActivo/'+nick,
            success:function(data){
                const estado = data.activo ? 
                    '<span class="badge badge-success">Activo</span>' : 
                    '<span class="badge badge-warning">No activo</span>';
                $('#resultadoVerificar').html(estado);
            }
        });
    }
}

function ejecutarEliminarUsuario() {
    const nick = $('#nickEliminar').val();
    if(nick) {
        $.ajax({
            type:'GET',
            url:'/eliminarUsuario/'+nick,
            success:function(data){
                const mensaje = data.nick !== -1 ? 
                    '<small class="text-success">Usuario eliminado</small>' : 
                    '<small class="text-warning">Usuario no encontrado</small>';
                $('#resultadoEliminar').html(mensaje);
                $('#nickEliminar').val('');
            }
        });
    }
}

function limpiarTodo() {
    $('[id^="result-"]').empty();
}
</script>
</body>
</html>